# CLAUDE.md

このファイルは、このリポジトリでClaude Code (claude.ai/code) が作業する際のガイダンスを提供します。

## プロジェクト概要

Sh4der Jockey は、シェーダーコーディングとライブパフォーマンス用のRustベースのツールです。YAMLファイルで定義されたカスタムレンダーパイプラインをサポートし、オーディオリアクティブエフェクト、MIDI制御、ライブシェーダーリロード機能をパフォーマンスとプロトタイピングに提供します。

## 開発コマンド

### ビルドと実行
```bash
# プロジェクトをビルドして実行
cargo run

# リリースビルド
cargo build --release

# バイナリをローカルにインストール
cargo install --path .

# サンプルファイルで新しいプロジェクトを初期化
cargo run -- init
```

### リントとテスト
```bash
# clippyでコードをチェック
cargo clippy

# テストを実行（もしあれば）
cargo test

# コードをフォーマット
cargo fmt
```

## アーキテクチャ概要

### コアコンポーネント

- **`src/main.rs`**: CLIパーサーとメインループのエントリーポイント
- **`src/jockey/mod.rs`**: 全アプリケーション状態とコアレンダーループを含むメイン`Jockey`構造体
- **`src/jockey/pipeline.rs`**: パイプラインの読み込み、コンパイル、管理
- **`src/jockey/stage.rs`**: 個別シェーダーステージ実行（フラグメント、頂点、コンピュート）
- **`src/jockey/audio.rs`**: オーディオ入力処理とFFT解析
- **`src/jockey/midi.rs`**: MIDIデバイス処理とコントロールバインディング
- **`src/jockey/osc.rs`**: OSC（Open Sound Control）メッセージ受信と処理
- **`src/jockey/config.rs`**: 設定ファイル解析とデバイス管理
- **`src/jockey/uniforms.rs`**: シェーダーユニフォーム管理とバインディング
- **`src/jockey/network.rs`**: NDI（Network Device Interface）サポート

### 主要コンセプト

1. **パイプラインシステム**: YAMLファイルで複数シェーダーステージのレンダーパイプラインを定義
2. **ライブリロード**: ファイルウォッチャーが変更時に自動的にシェーダーを再コンパイル
3. **オーディオ統合**: 複数テクスチャ出力（サンプル、スペクトラム、低音/中音/高音周波数）のリアルタイムオーディオ解析
4. **MIDI制御**: ライブパフォーマンス制御用のバインド可能なスライダーとボタン
5. **OSC制御**: OSCメッセージによる外部制御（float、int、bool型をサポート）
6. **レンダーターゲット**: マルチパスレンダリング用のカスタムフレームバッファ

### サポートされるシェーダータイプ

- **フラグメントシェーダー**: オーディオユニフォーム付き標準ピクセルシェーダー
- **頂点シェーダー**: パーティクルシステムとカスタムジオメトリ用
- **コンピュートシェーダー**: GPU計算とテクスチャ生成用

### 設定ファイル

- **`config.yaml`**: MIDIデバイスとオーディオ入力のプロジェクト全体設定
- **`*.yaml`**（パイプラインファイル）: レンダーステージ、シェーダー、依存関係を定義
- **`imgui-layout.ini`**: UIレイアウト永続化
- **`midi-config.dat`**: MIDIバインディング永続化

### 外部依存関係

- レンダリング用OpenGL
- コントロールパネルUI用ImGui
- オーディオ入力用CPAL
- ビデオ入力用NDI SDK（オプション）
- `notify`クレートによるファイル監視

## 開発ガイドライン

### シェーダー開発
- フラグメントシェーダーは`out_color`に出力する必要があります
- 共通ユニフォームには`time`、`resolution`、`beat`、`sliders[32]`、`buttons[32]`が含まれます
- オーディオテクスチャ: `samples`、`spectrum`、`spectrum_smooth`、低音/中音/高音バリアント
- カスタムユニフォームはパイプラインYAMLファイルで定義可能
- OSC制御: パイプラインYAMLの`osc`セクションでOSCアドレスをユニフォームにマッピング可能（float、int、boolをサポート）

### パイプライン設定
- 作業ディレクトリに`.yaml`ファイルを配置（`config.yaml`除く）
- ステージは依存関係解決とともに順序通りに実行
- レンダーターゲットはステージ間で共有可能
- コンピュートディスパッチと頂点/フラグメントレンダリングをサポート
- OSC設定: ポート番号とアドレスマッピングを`osc`セクションで定義（デフォルトポート: 9000）

### パフォーマンス考慮事項
- ライブリロード機能付きリアルタイムレンダリング
- レンダーループ全体でのOpenGL状態管理
- ブロッキングを避けるための非同期パイプラインコンパイル
- ステージごとのパフォーマンス指標追跡

### プラットフォーム固有の注意点
- Windows: リリースビルド用コンソールウィンドウ管理
- クロスプラットフォームオーディオデバイス検出
- glutinによるOpenGLコンテキスト管理
- プラットフォーム間でのファイル監視